# Cloud Deployment Guide

This guide walks you through deploying the TxEventQ serverless application to Oracle Cloud Infrastructure (OCI).

## Prerequisites

Ensure you have:
- OCI CLI configured with valid credentials
- Terraform installed
- Access to an OCI tenancy with appropriate permissions
- OCIR (Oracle Cloud Infrastructure Registry) access
- SMTP server credentials for production email delivery

## Step 1: Prepare Configuration

### 1.1 Create Terraform Variables File

Create `terraform/production.tfvars`:

```hcl
# OCI Configuration
tenancy_ocid     = "ocid1.tenancy.oc1..xxx"
compartment_ocid = "ocid1.compartment.oc1..xxx"
region           = "us-ashburn-1"

# Network Configuration
vcn_cidr            = "10.0.0.0/16"
public_subnet_cidr  = "10.0.1.0/24"
private_subnet_cidr = "10.0.2.0/24"

# Autonomous Database
adb_db_name         = "txeventqdb"
adb_display_name    = "TxEventQ DB"
adb_admin_password  = "YourSecurePassword123#"
adb_wallet_password = "WalletPassword123#"

# Database User
db_username = "ADMIN"
db_password = "YourSecurePassword123#"

# Object Storage
bucket_name = "txeventq-reports"

# Queue Configuration
queue_name        = "REPORT_QUEUE"
batch_size        = "5"
par_validity_days = "7"

# SMTP Configuration
smtp_username     = "your-smtp-username"
smtp_password     = "your-smtp-password"
sender_email      = "noreply@yourdomain.com"
recipient_emails  = "user1@example.com,user2@example.com"

# Function Configuration
function_memory_mb = 256

# Container Registry
ocir_region        = "us-ashburn-1"
tenancy_namespace  = "your-tenancy-namespace"
ocir_repo          = "txeventq-processor"
image_tag          = "latest"
```

### 1.2 Get Your Tenancy Namespace

```bash
oci os ns get
```

## Step 2: Deploy Infrastructure with Terraform

### 2.1 Initialize Terraform

```bash
cd terraform
terraform init
```

### 2.2 Review Deployment Plan

```bash
terraform plan -var-file=production.tfvars
```

### 2.3 Deploy Infrastructure

```bash
terraform apply -var-file=production.tfvars
```

This will create:
- VCN with public and private subnets
- Internet Gateway, NAT Gateway, Service Gateway
- Autonomous Database 23ai (1 OCPU)
- Object Storage bucket
- OCI Functions application and function
- Resource Scheduler schedule
- All required IAM policies and security lists

### 2.4 Save Terraform Outputs

```bash
terraform output -json > outputs.json
```

Important outputs:
- `adb_connection_string` - Database connection string
- `wallet_base64` - Base64-encoded wallet for function
- `function_ocid` - Function OCID

## Step 3: Setup Autonomous Database

### 3.1 Download Wallet

The wallet is automatically generated by Terraform. Extract it from outputs:

```bash
terraform output -raw wallet_base64 | base64 -d > wallet.zip
unzip wallet.zip -d wallet/
```

### 3.2 Create Queue in ADB

```bash
# Get connection string from Terraform output
export ADB_CONN=$(terraform output -raw adb_connection_string)

# Connect as ADMIN
sql ADMIN/YourSecurePassword123#@${ADB_CONN}
```

Run the queue creation script:
```sql
-- Drop existing queue (if exists)
BEGIN
    DBMS_AQADM.STOP_QUEUE(queue_name => 'REPORT_QUEUE');
    DBMS_AQADM.DROP_QUEUE(queue_name => 'REPORT_QUEUE');
    DBMS_AQADM.DROP_QUEUE_TABLE(queue_table => 'REPORT_QUEUE_TABLE');
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- Create TxEventQ queue
BEGIN
    DBMS_AQADM.CREATE_TRANSACTIONAL_EVENT_QUEUE(
        queue_name => 'REPORT_QUEUE',
        queue_payload_type => 'JSON',
        multiple_consumers => FALSE,
        storage_clause => NULL,
        comment => 'Queue for report generation requests'
    );
END;
/

-- Start queue
BEGIN
    DBMS_AQADM.START_QUEUE(queue_name => 'REPORT_QUEUE');
END;
/

-- Set retention time (7 days)
BEGIN
    DBMS_AQADM.SET_QUEUE_TABLE_PROPERTY(
        queue_table => 'REPORT_QUEUE_TABLE',
        property => 'RETENTION_TIME',
        value => '604800'
    );
END;
/

-- Verify queue
SELECT queue_name, queue_type, enqueue_enabled, dequeue_enabled
FROM USER_QUEUES
WHERE queue_name = 'REPORT_QUEUE';
```

### 3.3 DRCP Configuration

DRCP (Database Resident Connection Pooling) is automatically enabled on Autonomous Database. The connection string must use the `:POOLED` suffix:

```
jdbc:oracle:thin:@txeventqdb_high?TNS_ADMIN=/tmp/wallet:POOLED
```

The function automatically sets the DRCP connection class when `ENVIRONMENT=PRODUCTION`.

## Step 4: Build and Deploy Function

### 4.1 Login to OCIR

```bash
# Get your auth token from OCI Console (User Settings → Auth Tokens)
docker login <region>.ocir.io -u '<tenancy-namespace>/<username>'
# Enter your auth token as password
```

### 4.2 Build Function Container

```bash
cd function
fn build
```

### 4.3 Push to OCIR

```bash
fn push --registry <region>.ocir.io/<tenancy-namespace>/txeventq-processor
```

### 4.4 Deploy Function to OCI

The function is automatically deployed by Terraform, but you can update it:

```bash
# Get function OCID from Terraform output
export FUNCTION_OCID=$(terraform output -raw function_ocid)

# Update function with new image
oci fn function update \
  --function-id ${FUNCTION_OCID} \
  --image <region>.ocir.io/<tenancy-namespace>/txeventq-processor:latest
```

## Step 5: Test the Deployment

### 5.1 Enqueue Test Messages

```bash
sql ADMIN/YourSecurePassword123#@${ADB_CONN}
```

```sql
DECLARE
    enqueue_options    DBMS_AQ.ENQUEUE_OPTIONS_T;
    message_properties DBMS_AQ.MESSAGE_PROPERTIES_T;
    message_handle     RAW(16);
    message            JSON;
BEGIN
    message := JSON('{"title": "Production Test Report", "content": "This is a production test...", "date": "2025-01-25T10:00:00Z"}');

    DBMS_AQ.ENQUEUE(
        queue_name         => 'REPORT_QUEUE',
        enqueue_options    => enqueue_options,
        message_properties => message_properties,
        payload            => message,
        msgid              => message_handle
    );

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Enqueued test message');
END;
/
```

### 5.2 Manually Invoke Function

```bash
echo '{}' | oci fn function invoke --function-id ${FUNCTION_OCID}
```

Expected output:
```
Processed 1 messages
```

### 5.3 Verify Results

**Check Object Storage**:
```bash
oci os object list --bucket-name txeventq-reports --namespace <tenancy-namespace>
```

**Check Function Logs**:
```bash
oci logging-search search-logs \
  --search-query "search \"<compartment-ocid>/<log-group-id>\" | source='${FUNCTION_OCID}'" \
  --time-start $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)
```

**Check Email Delivery**:
Verify that emails were sent to the configured recipients.

## Step 6: Monitor Periodic Execution

The OCI Resource Scheduler automatically triggers the function based on the configured CRON schedule (default: every hour).

### 6.1 Check Schedule Status

```bash
oci resource-scheduler schedule list --compartment-id <compartment-ocid>
```

### 6.2 View Schedule Details

```bash
oci resource-scheduler schedule get --schedule-id <schedule-ocid>
```

### 6.3 Pause Processing

To temporarily stop processing:

**Option 1: Disable schedule**
```bash
oci resource-scheduler schedule update --schedule-id <schedule-ocid> --state INACTIVE
```

**Option 2: Set function concurrency to 0**
```bash
oci fn function update --function-id ${FUNCTION_OCID} --config '{"concurrency": "0"}'
```

## Monitoring and Troubleshooting

### Check Queue Depth

```bash
sql ADMIN/YourSecurePassword123#@${ADB_CONN}
```

```sql
SELECT COUNT(*) FROM AQ$REPORT_QUEUE_TABLE;
```

### View Function Metrics

OCI Console → Developer Services → Functions → Select application → Select function → Metrics

Key metrics:
- Invocations
- Duration
- Errors

### Common Issues

**Wallet Extraction Fails**:
- Verify base64 encoding: `terraform output -raw wallet_base64 | base64 -d > test.zip && unzip -t test.zip`
- Check function memory (256MB minimum)

**Database Connection Timeout**:
- Verify NSG rules allow function → ADB:1522
- Check NAT Gateway configured in private subnet route table
- Ensure connection string uses `:POOLED` suffix for DRCP

**Email Not Sent**:
- Verify SMTP credentials in function configuration
- Check SMTP server accessibility from OCI
- Test SMTP connectivity: `telnet <smtp-host> <smtp-port>`

**Function Not Triggered**:
- Verify schedule is active: `oci resource-scheduler schedule get --schedule-id <schedule-ocid>`
- Check schedule CRON expression is valid
- Review function logs for invocation history
- Verify Resource Scheduler dynamic group and policies are configured

## Scaling Considerations

### Increase Function Memory

```bash
oci fn function update \
  --function-id ${FUNCTION_OCID} \
  --memory-in-mbs 512
```

### Scale ADB OCPU

```bash
oci db autonomous-database update \
  --autonomous-database-id <adb-ocid> \
  --cpu-core-count 2
```

### Adjust Batch Size

```bash
oci fn function update \
  --function-id ${FUNCTION_OCID} \
  --config '{"BATCH_SIZE": "10"}'
```

### Adjust Schedule Frequency

Update the CRON expression in Terraform variables or via OCI Console to change trigger interval (e.g., every 2 hours: "0 */2 * * *"). Minimum interval is 1 hour.

## Cleanup

To destroy all resources:

```bash
cd terraform
terraform destroy -var-file=production.tfvars
```

**Warning**: This will permanently delete:
- Autonomous Database (and all data)
- Object Storage bucket (and all files)
- All network resources
- Functions and applications
- Resource Scheduler schedule

## Cost Optimization

- Set function concurrency limit to prevent runaway costs
- Use DRCP connection pooling to reduce database connections
- Set appropriate PAR validity period (7 days default)
- Monitor Object Storage usage and set lifecycle policies
- Review and adjust batch size based on workload

## Next Steps

- Configure production SMTP server
- Set up custom email templates
- Implement additional monitoring and alerting
- Configure backup and disaster recovery
- Review security best practices

## Additional Resources

- **[IMPLEMENTATION.md](IMPLEMENTATION.md)** - Complete implementation reference
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - Detailed architecture documentation
- **[README.md](README.md)** - Project overview
